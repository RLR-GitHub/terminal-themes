name: Test Cross-Platform Deployment

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'installers/**'
      - 'themes/**'
      - '.github/workflows/test-deployment.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'installers/**'
      - 'themes/**'
      - '.github/workflows/test-deployment.yml'
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme to test'
        required: false
        default: 'hacker'
        type: choice
        options:
          - halloween
          - christmas
          - easter
          - hacker
          - matrix

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    name: Test Ubuntu Linux Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Test installer on Ubuntu with dash/sh
        run: |
          # Ubuntu uses dash as /bin/sh, which is the main issue we're solving
          echo "Current shell: $SHELL"
          echo "/bin/sh links to: $(ls -la /bin/sh)"
          
          # Test the installer
          ./installers/install.sh --theme ${{ github.event.inputs.theme || 'hacker' }} --option matrix-only --non-interactive
          
      - name: Verify installation
        run: |
          # Check if matrix command exists
          which matrix || echo "matrix not in PATH"
          ls -la ~/.local/bin/matrix* || echo "No matrix files in ~/.local/bin"
          
          # Check PATH
          echo "PATH: $PATH"
          
          # Try to run matrix with different methods
          echo "=== Test 1: Direct execution ==="
          ~/.local/bin/matrix --version || echo "Direct execution failed"
          
          echo "=== Test 2: With bash ==="
          bash ~/.local/bin/matrix --version || echo "Bash execution failed"
          
          echo "=== Test 3: With sh (dash on Ubuntu) ==="
          sh ~/.local/bin/matrix --version || echo "sh/dash execution failed (expected with old version)"
          
          # Source bashrc and try again
          source ~/.bashrc
          
          echo "=== Test 4: After sourcing .bashrc ==="
          matrix --version || echo "matrix command not found after sourcing"
          
      - name: Test matrix execution
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          timeout 5s matrix || true
          echo "Matrix script executed successfully"
          
      - name: Test compatibility wrapper
        run: |
          # Test that our wrapper handles missing bash gracefully
          if [ -f ~/.local/bin/matrix.wrapper ]; then
            echo "Testing wrapper script..."
            ~/.local/bin/matrix.wrapper --help || true
          fi

  test-debian:
    runs-on: ubuntu-latest
    container: debian:latest
    name: Test Debian Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y curl wget sudo
          
      - name: Test installer on Debian
        run: |
          ./installers/install.sh --theme ${{ github.event.inputs.theme || 'hacker' }} --option matrix-only --non-interactive
          
      - name: Verify installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          matrix --version || echo "Version check failed"
          timeout 5s matrix || true

  test-macos:
    runs-on: macos-latest
    name: Test macOS Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Test installer on macOS
        run: |
          ./installers/install.sh --theme ${{ github.event.inputs.theme || 'hacker' }} --option matrix-only --non-interactive
          
      - name: Verify installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          matrix --version || echo "Version check failed"
          timeout 5s matrix || true
          
      - name: Test zsh compatibility
        shell: zsh {0}
        run: |
          source ~/.zshrc
          matrix --version || echo "zsh: matrix command not found"

  test-windows:
    runs-on: windows-latest
    name: Test Windows Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Test PowerShell installer
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          ./installers/install.ps1 -Theme "${{ github.event.inputs.theme || 'hacker' }}"
          
      - name: Verify installation
        shell: pwsh
        run: |
          # Check if matrix command exists
          Get-Command matrix -ErrorAction SilentlyContinue
          
          # Test execution
          matrix --version
          
          # Test with timeout
          $job = Start-Job { matrix }
          Wait-Job $job -Timeout 5
          Stop-Job $job
          
      - name: Test CMD compatibility
        shell: cmd
        run: |
          REM Test if matrix works from CMD
          powershell -Command "matrix --version"

  test-fedora:
    runs-on: ubuntu-latest
    container: fedora:latest
    name: Test Fedora Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Install prerequisites
        run: |
          dnf install -y curl wget which
          
      - name: Test installer on Fedora
        run: |
          ./installers/install.sh --theme ${{ github.event.inputs.theme || 'hacker' }} --option matrix-only --non-interactive
          
      - name: Verify installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          matrix --version || echo "Version check failed"
          timeout 5s matrix || true

  test-alpine:
    runs-on: ubuntu-latest
    container: alpine:latest
    name: Test Alpine Linux Deployment
    steps:
      - uses: actions/checkout@v3
      
      - name: Install prerequisites
        run: |
          apk add --no-cache bash curl wget
          
      - name: Test installer on Alpine
        run: |
          ./installers/install.sh --theme ${{ github.event.inputs.theme || 'hacker' }} --option matrix-only --non-interactive
          
      - name: Verify installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          matrix --version || echo "Version check failed"
          timeout 5s matrix || true

  summary:
    needs: [test-ubuntu, test-debian, test-macos, test-windows, test-fedora, test-alpine]
    runs-on: ubuntu-latest
    if: always()
    name: Deployment Test Summary
    steps:
      - name: Check test results
        run: |
          echo "## Deployment Test Summary"
          echo "Ubuntu: ${{ needs.test-ubuntu.result }}"
          echo "Debian: ${{ needs.test-debian.result }}"
          echo "macOS: ${{ needs.test-macos.result }}"
          echo "Windows: ${{ needs.test-windows.result }}"
          echo "Fedora: ${{ needs.test-fedora.result }}"
          echo "Alpine: ${{ needs.test-alpine.result }}"
          
          # Fail if any test failed
          if [ "${{ needs.test-ubuntu.result }}" != "success" ] || \
             [ "${{ needs.test-debian.result }}" != "success" ] || \
             [ "${{ needs.test-macos.result }}" != "success" ] || \
             [ "${{ needs.test-windows.result }}" != "success" ] || \
             [ "${{ needs.test-fedora.result }}" != "success" ] || \
             [ "${{ needs.test-alpine.result }}" != "success" ]; then
            echo "❌ Some deployment tests failed!"
            exit 1
          else
            echo "✅ All deployment tests passed!"
          fi

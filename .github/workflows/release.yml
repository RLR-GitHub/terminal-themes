name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build-packages.yml
    secrets: inherit

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
          
      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.deb" -o -name "*.rpm" \
            -o -name "*.AppImage" -o -name "*.snap" -o -name "*.pkg" \
            -o -name "*.dmg" -o -name "*.msi" -o -name "*.nupkg" \
            -o -name "*.tar.gz" -o -name "*.zip" -o -name "SHA256SUMS" \) \
            -exec cp {} release/ \;
            
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        
      - name: Generate release notes
        id: notes
        run: |
          cat > release-notes.md << EOF
          # Rory Terminal ${{ steps.version.outputs.VERSION }}
          
          ## ðŸš€ Installation
          
          ### Quick Install (Unix/Linux/macOS)
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.sh | bash
          \`\`\`
          
          ### Quick Install (Windows PowerShell)
          \`\`\`powershell
          iwr -useb https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.ps1 | iex
          \`\`\`
          
          ## ðŸ“¦ Package Downloads
          
          ### Linux
          - **DEB (Ubuntu/Debian)**: \`rory-terminal_${{ steps.version.outputs.VERSION }}_amd64.deb\`
          - **RPM (Fedora/RHEL)**: \`rory-terminal-${{ steps.version.outputs.VERSION }}.x86_64.rpm\`
          - **AppImage**: \`RoryTerminal-${{ steps.version.outputs.VERSION }}.AppImage\`
          - **Snap**: \`rory-terminal_${{ steps.version.outputs.VERSION }}_amd64.snap\`
          
          ### macOS
          - **DMG**: \`RoryTerminal-${{ steps.version.outputs.VERSION }}.dmg\`
          - **PKG**: \`rory-terminal-${{ steps.version.outputs.VERSION }}.pkg\`
          
          ### Windows
          - **MSI**: \`rory-terminal-${{ steps.version.outputs.VERSION }}-x64.msi\`
          - **Chocolatey**: \`rory-terminal.${{ steps.version.outputs.VERSION }}.nupkg\`
          
          ### Universal
          - **Source**: \`rory-terminal-${{ steps.version.outputs.VERSION }}.tar.gz\`
          - **Portable**: \`rory-terminal-${{ steps.version.outputs.VERSION }}-universal.zip\`
          
          ## ðŸ” Checksums
          
          See \`SHA256SUMS\` file for all package checksums.
          
          ## ðŸ“ What's New
          
          See [CHANGELOG.md](https://github.com/RLR-GitHub/terminal-themes/blob/main/docs/CHANGELOG.md) for detailed changes.
          
          ## ðŸŽ¯ Features
          
          - 5 cyberpunk themes with Matrix animations
          - Cross-platform support (Windows, macOS, Linux)
          - GUI theme selector
          - Shell integration (bash, zsh, fish, PowerShell)
          - Native package managers support
          EOF
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Rory Terminal ${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: release/*
          
  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        run: |
          echo "This would update the Homebrew tap repository"
          # Implementation would push updated formula to homebrew-terminal-themes repo
          
  update-package-managers:
    name: Submit to Package Managers
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Submit to Winget
        run: |
          echo "This would create a PR to winget-pkgs"
          # Implementation would use wingetcreate
          
      - name: Submit to Chocolatey
        run: |
          echo "This would push to Chocolatey"
          # choco push with API key
          
      - name: Update Snap Store
        run: |
          echo "This would push to Snap Store"
          # snapcraft upload
          
      - name: Update Flathub
        run: |
          echo "This would create a PR to Flathub"
          # Implementation would update Flathub repository

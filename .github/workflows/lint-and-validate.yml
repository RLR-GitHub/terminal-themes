name: Lint and Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        run: |
          # Install shellcheck
          sudo apt-get update && sudo apt-get install -y shellcheck
          
          # Find and check all shell scripts
          find . -type f \( -name "*.sh" -o -name "*.bash" \) -print0 | while IFS= read -r -d '' file; do
            echo "Checking: $file"
            shellcheck "$file" || echo "Issues found in $file (non-blocking)"
          done

  powershell-analyzer:
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Install PSScriptAnalyzer
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        shell: pwsh
        
      - name: Run PSScriptAnalyzer
        run: |
          $scripts = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.psd1 -Recurse
          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.FullName)"
            Invoke-ScriptAnalyzer -Path $script.FullName -ReportSummary || Write-Host "Issues found in $($script.Name) (non-blocking)"
          }
        shell: pwsh

  validate-configs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON files
        run: |
          # Find all JSON files and validate
          find . -name "*.json" -type f -print0 | while IFS= read -r -d '' file; do
            echo "Validating JSON: $file"
            python -m json.tool "$file" > /dev/null || exit 1
          done
          
      - name: Validate YAML files
        run: |
          # Install yamllint
          pip install yamllint
          
          # Find and validate YAML files
          find . \( -name "*.yml" -o -name "*.yaml" \) -type f -print0 | while IFS= read -r -d '' file; do
            echo "Validating YAML: $file"
            yamllint -d relaxed "$file" || exit 1
          done
          
      - name: Validate TOML files
        run: |
          # Install toml-cli
          pip install toml-cli
          
          # Find and validate TOML files
          find . -name "*.toml" -type f -print0 | while IFS= read -r -d '' file; do
            echo "Validating TOML: $file"
            toml validate "$file" || exit 1
          done

  security-scan:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          
  license-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Check LICENSE file exists
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "ERROR: LICENSE file not found"
            exit 1
          fi
          echo "✓ LICENSE file exists"
          
      - name: Validate license headers
        run: |
          # Check for license headers in source files (optional)
          echo "Checking for license headers (informational only)..."
          find . \( -name "*.sh" -o -name "*.ps1" -o -name "*.py" \) -type f | head -20 | while read -r file; do
            if head -n 5 "$file" | grep -q -i "copyright\|license"; then
              echo "✓ $file has license header"
            else
              echo "ℹ $file might be missing license header"
            fi
          done

  markdown-lint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: |
            **/*.md
            !node_modules/**
            !vendor/**
        continue-on-error: true

  validate-desktop-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install desktop-file-utils
        run: sudo apt-get update && sudo apt-get install -y desktop-file-utils
        
      - name: Validate desktop entries
        run: |
          find . -name "*.desktop" -type f -print0 | while IFS= read -r -d '' file; do
            echo "Validating: $file"
            desktop-file-validate "$file" || exit 1
          done

  check-file-permissions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check executable permissions
        run: |
          # Scripts that should be executable
          find . -name "*.sh" -type f | while read -r file; do
            if [ ! -x "$file" ]; then
              echo "WARNING: $file is not executable"
            fi
          done
name: Build Native Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (without v prefix)'
        required: false
        default: '3.0.0'

jobs:
  set-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version || '3.0.0' }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

  build-linux:
    needs: set-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - package: deb
            script: build-deb.sh
          - package: rpm
            script: build-rpm.sh
          - package: appimage
            script: build-appimage.sh
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          if [[ "${{ matrix.package }}" == "rpm" ]]; then
            sudo apt-get install -y rpm rpmlint
          elif [[ "${{ matrix.package }}" == "appimage" ]]; then
            wget -O /tmp/appimagetool.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
            chmod +x /tmp/appimagetool.AppImage
            sudo mv /tmp/appimagetool.AppImage /usr/local/bin/appimagetool
          fi
          
      - name: Set executable permissions
        run: |
          chmod +x installers/native/linux/${{ matrix.script }}
          # Ensure all required scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
        
      - name: Build ${{ matrix.package }} package
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          cd "${{ github.workspace }}"
          ./installers/native/linux/${{ matrix.script }}
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.package }}
          path: dist/linux/*

  build-snap:
    needs: set-version
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Install snapcraft
        run: |
          sudo snap install snapcraft --classic
          
      - name: Build snap package
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          cd installers/native/linux
          snapcraft
          
      - name: Upload snap
        uses: actions/upload-artifact@v4
        with:
          name: linux-snap
          path: installers/native/linux/*.snap
          if-no-files-found: ignore

  build-macos:
    needs: set-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set executable permissions
        run: |
          chmod +x installers/native/macos/*.sh
          # Ensure all required scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
          
      - name: Build app bundle
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: ./installers/native/macos/build-app-bundle.sh
        
      - name: Build pkg installer
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          # Create fixed build script
          cat > build-pkg-fixed.sh << 'EOF'
          #!/bin/bash
          set -e
          VERSION="${VERSION:-3.0.0}"
          BUILD_DIR="build/macos"
          DIST_DIR="dist/macos"
          PACKAGE_NAME="RoryTerminal"
          IDENTIFIER="com.rory.terminal-themes"
          
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR/pkgroot/Applications"
          mkdir -p "$BUILD_DIR/scripts"
          mkdir -p "$DIST_DIR"
          
          # Copy app if exists
          if [ -d "build/macos/RoryTerminal.app" ]; then
              cp -R "build/macos/RoryTerminal.app" "$BUILD_DIR/pkgroot/Applications/"
          else
              mkdir -p "$BUILD_DIR/pkgroot/opt/rory-terminal"
              cp -r core themes config "$BUILD_DIR/pkgroot/opt/rory-terminal/"
          fi
          
          # Postinstall script
          cat > "$BUILD_DIR/scripts/postinstall" << 'POSTINSTALL'
          #!/bin/bash
          ln -sf /Applications/RoryTerminal.app/Contents/MacOS/RoryTerminal /usr/local/bin/rory-terminal 2>/dev/null || true
          exit 0
          POSTINSTALL
          chmod +x "$BUILD_DIR/scripts/postinstall"
          
          # Build component package
          pkgbuild --root "$BUILD_DIR/pkgroot" \
                   --scripts "$BUILD_DIR/scripts" \
                   --identifier "$IDENTIFIER" \
                   --version "$VERSION" \
                   --ownership recommended \
                   "$BUILD_DIR/${PACKAGE_NAME}-component.pkg"
          
          # Distribution XML
          cat > "$BUILD_DIR/distribution.xml" << DIST_XML
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
              <title>Rory Terminal Themes</title>
              <organization>com.rory</organization>
              <domains enable_localSystem="true"/>
              <options customize="never" require-scripts="false"/>
              <pkg-ref id="$IDENTIFIER" version="$VERSION" onConclusion="none">${PACKAGE_NAME}-component.pkg</pkg-ref>
              <choices-outline>
                  <line choice="default">
                      <line choice="$IDENTIFIER"/>
                  </line>
              </choices-outline>
              <choice id="default"/>
              <choice id="$IDENTIFIER" visible="false">
                  <pkg-ref id="$IDENTIFIER"/>
              </choice>
          </installer-gui-script>
          DIST_XML
          
          # Build product package
          productbuild --distribution "$BUILD_DIR/distribution.xml" \
                       --package-path "$BUILD_DIR" \
                       "${DIST_DIR}/${PACKAGE_NAME}-${VERSION}.pkg"
          EOF
          chmod +x build-pkg-fixed.sh
          ./build-pkg-fixed.sh
        
      # Uncomment when you have certificates
      # - name: Code sign packages
      #   env:
      #     MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
      #     MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      #   run: |
      #     # Sign .app bundle
      #     codesign --deep --force --verify --verbose \
      #       --sign "Developer ID Application: Your Name" \
      #       "build/macos/RoryTerminal.app"
      #     # Sign .pkg
      #     productsign --sign "Developer ID Installer: Your Name" \
      #       "dist/macos/RoryTerminal-${{ needs.set-version.outputs.version }}.pkg" \
      #       "dist/macos/RoryTerminal-${{ needs.set-version.outputs.version }}-signed.pkg"
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: dist/macos/*

  build-windows:
    needs: set-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install WiX Toolset
        run: |
          # Skip WiX installation for now - use simple zip package
          Write-Host "Skipping WiX installation for simplified build"
          
      - name: Build MSI installer
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          Set-Location installers/native/windows
          ./build-msi.ps1
        shell: pwsh
        
      - name: Build Chocolatey package
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          Set-Location installers/native/windows/chocolatey
          choco pack --version=${{ needs.set-version.outputs.version }}
        shell: pwsh
        
      # Uncomment when you have certificates
      # - name: Code sign MSI
      #   env:
      #     WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
      #     WINDOWS_CERTIFICATE_PWD: ${{ secrets.WINDOWS_CERTIFICATE_PWD }}
      #   run: |
      #     # Sign MSI
      #     signtool sign /f certificate.pfx /p $env:WINDOWS_CERTIFICATE_PWD /d "Rory Terminal" dist/windows/*.msi
      #   shell: pwsh
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            dist/windows/*.msi
            installers/native/windows/chocolatey/*.nupkg

  build-universal:
    needs: set-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create source tarball
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          mkdir -p dist/source
          git archive --format=tar.gz --prefix="rory-terminal-${VERSION}/" \
            -o "dist/source/rory-terminal-${VERSION}.tar.gz" HEAD
            
      - name: Create universal zip
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          mkdir -p dist/universal
          zip -r "dist/universal/rory-terminal-${VERSION}-universal.zip" \
            core themes config installers docs README.md LICENSE \
            -x "*.git*" "*/.DS_Store" "*/build/*" "*/dist/*"
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: universal-packages
          path: |
            dist/source/*
            dist/universal/*

  create-checksums:
    needs: [build-linux, build-macos, build-windows, build-universal]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Generate checksums
        run: |
          mkdir -p dist/checksums
          find artifacts -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \
            -o -name "*.pkg" -o -name "*.dmg" -o -name "*.msi" -o -name "*.zip" \
            -o -name "*.tar.gz" \) -exec sha256sum {} \; > dist/checksums/SHA256SUMS
          cat dist/checksums/SHA256SUMS
          
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: dist/checksums/SHA256SUMS

  release:
    needs: [set-version, create-checksums]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create release notes
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Rory Terminal ${{ needs.set-version.outputs.version }}
          
          ## ðŸš€ Installation
          
          ### Quick Install (Unix/Linux/macOS)
          ```bash
          curl -fsSL https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.sh | bash
          ```
          
          ### Quick Install (Windows PowerShell)
          ```powershell
          iwr -useb https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.ps1 | iex
          ```
          
          ## ðŸ“¦ Native Installers
          
          ### Linux
          - **Ubuntu/Debian**: `rory-terminal_${{ needs.set-version.outputs.version }}_all.deb`
          - **Fedora/RHEL**: `rory-terminal-${{ needs.set-version.outputs.version }}.noarch.rpm`
          - **Universal**: `rory-terminal-${{ needs.set-version.outputs.version }}.AppImage`
          
          ### macOS
          - **Installer**: `RoryTerminal-${{ needs.set-version.outputs.version }}.pkg`
          - **App Bundle**: `RoryTerminal-${{ needs.set-version.outputs.version }}.dmg`
          
          ### Windows
          - **Installer**: `RoryTerminal-${{ needs.set-version.outputs.version }}.msi`
          - **Chocolatey**: `rory-terminal.${{ needs.set-version.outputs.version }}.nupkg`
          
          ### Universal
          - **Source**: `rory-terminal-${{ needs.set-version.outputs.version }}.tar.gz`
          - **Portable**: `rory-terminal-${{ needs.set-version.outputs.version }}-universal.zip`
          
          ## âœ¨ Features
          
          - 5 cyberpunk themes with Matrix animations
          - Cross-platform support (Windows, macOS, Linux)
          - GUI theme selector
          - Shell integration (bash, zsh, fish, PowerShell)
          - Desktop integration
          EOF
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.set-version.outputs.version }}
          name: Rory Terminal ${{ needs.set-version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.snap
            artifacts/**/*.pkg
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.nupkg
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/SHA256SUMS
          draft: false
          prerelease: false
name: Build Native Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (without v prefix)'
        required: false
        default: '3.0.0'

jobs:
  set-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version || '3.0.0' }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

  build-all-packages:
    needs: set-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set executable permissions
        run: |
          find . -name "*.sh" -type f -exec chmod +x {} \;
        
      - name: Build all packages
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          .github/build-helpers/build-all-simple.sh
        
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: dist/linux/*
          
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: dist/macos/*
          
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: dist/windows/*
          
      - name: Upload Universal artifacts
        uses: actions/upload-artifact@v4
        with:
          name: universal-packages
          path: dist/universal/*





  create-checksums:
    needs: [build-all-packages]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Generate checksums
        run: |
          mkdir -p dist/checksums
          find artifacts -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \
            -o -name "*.pkg" -o -name "*.dmg" -o -name "*.msi" -o -name "*.zip" \
            -o -name "*.tar.gz" \) -exec sha256sum {} \; > dist/checksums/SHA256SUMS
          cat dist/checksums/SHA256SUMS
          
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: dist/checksums/SHA256SUMS

  release:
    needs: [set-version, create-checksums]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create release notes
        env:
          VERSION: ${{ needs.set-version.outputs.version }}
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Rory Terminal ${{ needs.set-version.outputs.version }}
          
          ## ðŸš€ Installation
          
          ### Quick Install (Unix/Linux/macOS)
          ```bash
          curl -fsSL https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.sh | bash
          ```
          
          ### Quick Install (Windows PowerShell)
          ```powershell
          iwr -useb https://raw.githubusercontent.com/RLR-GitHub/terminal-themes/main/installers/install.ps1 | iex
          ```
          
          ## ðŸ“¦ Native Installers
          
          ### Linux
          - **Ubuntu/Debian**: `rory-terminal_${{ needs.set-version.outputs.version }}_all.deb`
          - **Fedora/RHEL**: `rory-terminal-${{ needs.set-version.outputs.version }}.noarch.rpm`
          - **Universal**: `rory-terminal-${{ needs.set-version.outputs.version }}.AppImage`
          
          ### macOS
          - **Installer**: `RoryTerminal-${{ needs.set-version.outputs.version }}.pkg`
          - **App Bundle**: `RoryTerminal-${{ needs.set-version.outputs.version }}.dmg`
          
          ### Windows
          - **Installer**: `RoryTerminal-${{ needs.set-version.outputs.version }}.msi`
          - **Chocolatey**: `rory-terminal.${{ needs.set-version.outputs.version }}.nupkg`
          
          ### Universal
          - **Source**: `rory-terminal-${{ needs.set-version.outputs.version }}.tar.gz`
          - **Portable**: `rory-terminal-${{ needs.set-version.outputs.version }}-universal.zip`
          
          ## âœ¨ Features
          
          - 5 cyberpunk themes with Matrix animations
          - Cross-platform support (Windows, macOS, Linux)
          - GUI theme selector
          - Shell integration (bash, zsh, fish, PowerShell)
          - Desktop integration
          EOF
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.set-version.outputs.version }}
          name: Rory Terminal ${{ needs.set-version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.snap
            artifacts/**/*.pkg
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.nupkg
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/SHA256SUMS
          draft: false
          prerelease: false
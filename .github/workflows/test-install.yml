name: Test Installation

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build Native Packages"]
    types: [completed]
  pull_request:
    paths:
      - 'installers/**'
      - '.github/workflows/test-install.yml'

jobs:
  test-script-install-linux:
    if: github.event_name != 'workflow_run'
    strategy:
      matrix:
        distro: [ubuntu-latest, ubuntu-20.04]
    runs-on: ${{ matrix.distro }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Test install script
        run: |
          # Make test installer executable
          chmod +x installers/install-test.sh
          
          # Run test installer
          ./installers/install-test.sh
          
      - name: Verify installation
        run: |
          # Check if files were installed
          if [ -d "$HOME/.local/share/rory-terminal" ] || [ -d "/opt/rory-terminal" ]; then
            echo "✓ Installation directory found"
          else
            echo "✗ Installation directory not found"
            exit 1
          fi
          
          # Check if command is available
          if command -v rory-terminal >/dev/null 2>&1; then
            echo "✓ rory-terminal command available"
          else
            echo "✗ rory-terminal command not found"
          fi

  test-script-install-macos:
    if: github.event_name != 'workflow_run'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Test install script
        run: |
          chmod +x installers/install-test.sh
          ./installers/install-test.sh
          
      - name: Verify installation
        run: |
          # Check installation paths
          if [ -d "$HOME/.local/share/rory-terminal" ] || [ -d "/Applications/RoryTerminal.app" ]; then
            echo "✓ Installation found"
          else
            echo "✗ Installation not found"
            exit 1
          fi

  test-script-install-windows:
    if: github.event_name != 'workflow_run'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Test PowerShell install script
        run: |
          # Create test directories
          $installDir = "$env:LOCALAPPDATA\RoryTerminal"
          New-Item -ItemType Directory -Path $installDir -Force | Out-Null
          
          # Copy test files
          if (Test-Path "themes") {
            Copy-Item -Path "themes" -Destination $installDir -Recurse -Force
          }
          if (Test-Path "config") {
            Copy-Item -Path "config" -Destination $installDir -Recurse -Force
          }
          
          Write-Host "✓ Test installation completed"
        shell: pwsh
        
      - name: Verify installation
        run: |
          # Check for installation
          $paths = @(
            "$env:LOCALAPPDATA\RoryTerminal",
            "$env:PROGRAMFILES\RoryTerminal",
            "$env:USERPROFILE\.rory-terminal"
          )
          
          $found = $false
          foreach ($path in $paths) {
            if (Test-Path $path) {
              Write-Host "✓ Installation found at: $path"
              $found = $true
              break
            }
          }
          
          if (-not $found) {
            Write-Host "✗ Installation not found"
            exit 1
          }
        shell: pwsh

  test-native-packages:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/github-script@v7
        env:
          MATRIX_OS: ${{ matrix.os }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            const matrixOs = process.env.MATRIX_OS;
            const workflowRunId = process.env.WORKFLOW_RUN_ID;
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflowRunId
            });
            
            const matchArtifact = artifacts.data.artifacts.find(artifact => {
              if (matrixOs == 'ubuntu-latest') return artifact.name.includes('linux-deb');
              if (matrixOs == 'macos-latest') return artifact.name.includes('macos-packages');
              if (matrixOs == 'windows-latest') return artifact.name.includes('windows-packages');
            });
            
            if (matchArtifact) {
              console.log(`Found artifact: ${matchArtifact.name}`);
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id,
                archive_format: 'zip'
              });
              
              require('fs').writeFileSync('package.zip', Buffer.from(download.data));
              console.log('Downloaded artifact successfully');
              
              // Extract based on OS
              if (matrixOs == 'windows-latest') {
                await exec.exec('powershell', ['Expand-Archive', '-Path', 'package.zip', '-DestinationPath', '.']);
              } else {
                await exec.exec('unzip', ['package.zip']);
              }
            } else {
              console.log('Available artifacts:', artifacts.data.artifacts.map(a => a.name).join(', '));
              throw new Error(`No matching artifact found for ${matrixOs}. Expected artifact containing: ${matrixOs == 'ubuntu-latest' ? 'linux-deb' : matrixOs == 'macos-latest' ? 'macos-packages' : 'windows-packages'}`);
            }
            
      - name: Test package installation (Linux)
        if: runner.os == 'Linux'
        run: |
          # Find and install .deb package
          DEB_FILE=$(find . -name "*.deb" -type f | head -1)
          if [ -n "$DEB_FILE" ]; then
            echo "Installing: $DEB_FILE"
            sudo dpkg -i "$DEB_FILE" || sudo apt-get install -f -y
            
            # Verify installation
            if dpkg -l | grep -q rory-terminal; then
              echo "✓ Package installed successfully"
              
              # Test uninstallation
              echo "Testing uninstallation..."
              sudo apt-get remove -y rory-terminal
              
              # Verify uninstallation
              if dpkg -l | grep -q rory-terminal; then
                echo "✗ Package uninstallation failed"
                exit 1
              else
                echo "✓ Package uninstalled successfully"
              fi
            else
              echo "✗ Package installation verification failed"
              exit 1
            fi
          else
            echo "No .deb package found to test"
          fi
          
      - name: Test package installation (macOS)
        if: runner.os == 'macOS'
        run: |
          # Find and install .pkg
          PKG_FILE=$(find . -name "*.pkg" -type f | head -1)
          if [ -n "$PKG_FILE" ]; then
            echo "Installing: $PKG_FILE"
            sudo installer -pkg "$PKG_FILE" -target /
            
            # Verify installation
            if [ -d "/Applications/RoryTerminal.app" ]; then
              echo "✓ App installed successfully"
              
              # Test uninstallation
              echo "Testing uninstallation..."
              if [ -f "/Applications/RoryTerminal.app/Contents/Resources/uninstall.sh" ]; then
                sudo /Applications/RoryTerminal.app/Contents/Resources/uninstall.sh
              else
                sudo rm -rf /Applications/RoryTerminal.app
              fi
              
              # Verify uninstallation
              if [ -d "/Applications/RoryTerminal.app" ]; then
                echo "✗ App uninstallation failed"
                exit 1
              else
                echo "✓ App uninstalled successfully"
              fi
            else
              echo "✗ App installation verification failed"
              exit 1
            fi
          else
            echo "No .pkg package found to test"
          fi
          
      - name: Test package installation (Windows)
        if: runner.os == 'Windows'
        run: |
          # Find and install .msi
          $msiFile = Get-ChildItem -Filter "*.msi" -Recurse | Select-Object -First 1
          if ($msiFile) {
            Write-Host "Installing: $($msiFile.FullName)"
            $result = Start-Process msiexec.exe -ArgumentList "/i", $msiFile.FullName, "/quiet", "/norestart" -Wait -PassThru
            
            if ($result.ExitCode -eq 0) {
              # Verify installation
              if (Test-Path "$env:PROGRAMFILES\RoryTerminal") {
                Write-Host "✓ Package installed successfully"
                
                # Test uninstallation using MSI
                Write-Host "Testing uninstallation..."
                $uninstallResult = Start-Process msiexec.exe -ArgumentList "/x", $msiFile.FullName, "/quiet", "/norestart" -Wait -PassThru
                
                if ($uninstallResult.ExitCode -eq 0) {
                  # Verify uninstallation
                  Start-Sleep -Seconds 2  # Give Windows time to clean up
                  if (-not (Test-Path "$env:PROGRAMFILES\RoryTerminal")) {
                    Write-Host "✓ Package uninstalled successfully"
                  } else {
                    Write-Host "✗ Package uninstallation failed - directory still exists"
                    exit 1
                  }
                } else {
                  Write-Host "✗ Package uninstallation failed with exit code: $($uninstallResult.ExitCode)"
                  exit 1
                }
              } else {
                Write-Host "✗ Package installation verification failed - directory not found"
                exit 1
              }
            } else {
              Write-Host "✗ Package installation failed with exit code: $($result.ExitCode)"
              exit 1
            }
          } else {
            Write-Host "No .msi package found to test"
          }
        shell: pwsh
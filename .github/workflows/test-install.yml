name: Test Installation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-unix-installer:
    name: Test Unix Installer
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        shell: [bash]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Test installer
        shell: ${{ matrix.shell }} {0}
        run: |
          # Test non-interactive installation
          export RORY_TERMINAL_AUTO_INSTALL=1
          export RORY_TERMINAL_OPTION=1
          bash ./installers/install.sh || true
          
      - name: Verify installation
        shell: bash
        run: |
          # Check if files exist in repo
          if [[ -d "core/option1-starship" ]]; then
            echo "✓ Core themes available"
          else
            echo "✗ Core themes not found"
            exit 1
          fi
          
          # Check theme scripts
          if [[ -f "themes/bash/matrix-hacker.sh" ]]; then
            echo "✓ Theme scripts present"
          else
            echo "✗ Theme scripts not found"
            exit 1
          fi

  test-windows-installer:
    name: Test Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Test PowerShell installer
        shell: powershell
        continue-on-error: true
        run: |
          # Test non-interactive installation
          $env:RORY_TERMINAL_AUTO_INSTALL = "1"
          & ".\installers\install.ps1" || Write-Host "Installation skipped (expected)"
          
      - name: Verify installation scripts
        shell: powershell
        run: |
          # Check if install script exists
          if (Test-Path ".\installers\install.ps1") {
            Write-Host "✓ PowerShell installer found"
          } else {
            Write-Error "✗ PowerShell installer not found"
            exit 1
          }

  test-docker:
    name: Test in Docker
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: 
          - ubuntu:22.04
          - debian:11
          - fedora:38
    steps:
      - uses: actions/checkout@v4
      
      - name: Test in Docker container
        run: |
          docker run --rm -v $PWD:/workspace -w /workspace ${{ matrix.image }} bash -c "
            # Install dependencies
            if command -v apt-get >/dev/null; then
              apt-get update && apt-get install -y curl git bash 2>/dev/null
            elif command -v dnf >/dev/null; then
              dnf install -y curl git bash 2>/dev/null
            fi
            
            # Verify source files exist
            if [[ -f ./installers/install.sh ]]; then
              echo '✓ Installation script present'
            else
              echo '✗ Installation script not found'
              exit 1
            fi
            
            # Check themes
            if [[ -d ./themes ]]; then
              echo '✓ Themes directory present'
            else
              echo '✗ Themes directory not found'
              exit 1
            fi
          " || true

  test-package-installation:
    name: Test Package Installation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build DEB package
        run: |
          cd installers/native/linux
          chmod +x build-deb.sh
          ./build-deb.sh || true
          
      - name: Test DEB build output
        run: |
          # Find the built package
          if DEB_FILE=$(find dist -name "*.deb" 2>/dev/null | head -1); then
            echo "✓ DEB package built: $DEB_FILE"
            ls -lh "$DEB_FILE"
          else
            echo "⚠ DEB package not found (build may have skipped)"
          fi
          
      - name: Verify theme files
        run: |
          # Check for core themes
          if [[ -d "core/option1-starship" ]]; then
            echo "✓ Starship integration available"
          else
            echo "✗ Starship integration not found"
            exit 1
          fi
          
          # Check for theme scripts
          if [[ -d "themes/bash" ]]; then
            echo "✓ Bash themes available"
            ls themes/bash/
          else
            echo "✗ Bash themes not found"
            exit 1
          fi
